#!/usr/bin/expect

# INTEL CONFIDENTIAL
#
# Copyright 2020-2020 Intel Corporation.
#
# This software and the related documents are Intel copyrighted materials, and your use of
# them is governed by the express license under which they were provided to you ("License").
# Unless the License provides otherwise, you may not use, modify, copy, publish, distribute,
# disclose or transmit this software or the related documents without Intel's prior written permission.
#
# This software and the related documents are provided as is, with no express or implied warranties,
# other than those that are expressly stated in the License.

set gnb_l1_ready "PHY>welcome to application console"

#deatach command
set dt_cmd "\01d" 
set green "\033\[0;32m"
set red "\033\[0;31m"
set reset "\033\[0;0m"

set timeout 300
set ::env(TERM) vt100

spawn screen -S gnb_l1 kubectl exec -it -n {{ cera_namespace_name }} {{ app_name }} -- bash
set gnb_id $spawn_id

expect  {
    -i $gnb_id "]#" {}
    timeout {
        puts "* ${red}Get iside pod timeout${reset}"
        send -i $gnb_id "$dt_cmd"
        exit 1
    }
}

send -i $gnb_id "rmmod igb_uio; \
insmod dpdk-19.11/x86_64-native-linuxapp-icc/kmod/igb_uio.ko; \
cd /root/gnodeb/flexran/bin/nr5g/gnb/l1/\n"
sleep 1
send -i $gnb_id "./l1.sh -xran\n"

expect {
    -i $gnb_id "$gnb_l1_ready" { puts "* ${green}L1 READY${reset}"}
    timeout {
        puts "* ${red}PHY timeout${reset}" 
        send -i $gnb_id "$dt_cmd"
        exit 1
    }
}
send -i $gnb_id "$dt_cmd"

sleep 1

interact
