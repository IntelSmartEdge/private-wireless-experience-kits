#!/bin/sh
# INTEL CONFIDENTIAL
#
# Copyright 2020-2022 Intel Corporation.
#
# This software and the related documents are Intel copyrighted materials, and your use of
# them is governed by the express license under which they were provided to you ("License").
# Unless the License provides otherwise, you may not use, modify, copy, publish, distribute,
# disclose or transmit this software or the related documents without Intel's prior written permission.
#
# This software and the related documents are provided as is, with no express or implied warranties,
# other than those that are expressly stated in the License.


BASEDIR=$(dirname "$0")
echo "$BASEDIR"

PWEKNS={{ pwek_namespace_name }}
TIMEOUT=300
NS=${NS:-$PWEKNS}

function check_helm_status {
  expire=$(( $(date +%s) + $TIMEOUT ))
  while true
  do
    status=$(helm status -n $1 $2 -o json | jq -r .info.status)
    if [ -z $status ]; then
      echo "Can not get status of $2 in $1 namespace, exit."
      return 0
    else
      echo "$2 status: $status"
    fi

    sleep 1
    if [ $(date +%s) -ge $expire ]; then
      echo "Timeout $TIMEOUT, status of $2 is still: $status, maybe something wrong with the system"
      return 1
    fi
  done
}

CHART=vdu
echo "helm uninstall $CHART -n $NS"
helm uninstall $CHART -n $NS
check_helm_status $NS $CHART
helm status -n $NS $CHART

CHART=vcu
echo "helm uninstall -n $NS $CHART"
helm uninstall -n $NS $CHART
check_helm_status $NS $CHART
helm status -n $NS $CHART
