# INTEL CONFIDENTIAL
#
# Copyright 2020-2020 Intel Corporation.
#
# This software and the related documents are Intel copyrighted materials, and your use of
# them is governed by the express license under which they were provided to you ("License").
# Unless the License provides otherwise, you may not use, modify, copy, publish, distribute,
# disclose or transmit this software or the related documents without Intel's prior written permission.
#
# This software and the related documents are provided as is, with no express or implied warranties,
# other than those that are expressly stated in the License.

---

- name: Copy local-dn chart to host
  copy:
    src: "local-dn-chart"
    dest: "{{ cera_charts_path }}"
    mode: preserve

- name: Copy local-dn image to host
  copy:
    src: "local-dn-image"
    dest: "{{ cera_images_path }}"
    mode: preserve

- name: Build local-dn image
  command: >
    docker build
    --build-arg http_proxy=$http_proxy
    --build-arg https_proxy=$https_proxy
    --build-arg no_proxy=$no_proxy
    -t local-dn:1.0 .
  args:
    chdir: "{{ cera_images_path }}/local-dn-image"
  changed_when: false

- name: create eis namespace if not exist
  block:
  - name: Check if namespace eis already exists
    command: kubectl get ns eis
    failed_when: false
    register: get_ns_eis
  - name: Create namespace eis
    command: kubectl create namespace eis
    when: get_ns_eis.rc == 1

- name: Deploy local-dn pod
  command: "helm install -n eis local-dn . --set nodeName={{ node_name }} --set namespace=eis"
  args:
    chdir: "{{ cera_charts_path }}/local-dn-chart"
  changed_when: false
