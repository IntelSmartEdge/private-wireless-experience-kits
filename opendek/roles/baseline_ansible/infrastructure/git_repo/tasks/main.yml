# SPDX-License-Identifier: Apache-2.0
# Copyright (c) 2019 Intel Corporation

---
- name: create temporary custom .smartedge_gitconfig
  include_tasks: ./gitconfig_bootstrap.yml

- name: online mode
  block:
    - name: "Check Git configuration"
      debug:
        msg: "Using git token for repository checkout"
      when: git_repo_token|length > 0

    - name: make sure project directory exists
      file:
        path: "{{ project_dir }}"
        state: directory
        mode: a=rwx
        owner: "{{ ansible_user }}"
      become: yes

    - name: checkout clean repository - "{{ git_repo_url }}"
      git:
        repo: "{{ git_repo_url }}"
        dest: "{{ git_repo_dest }}"
        version: "{{ git_repo_branch }}"
        accept_hostkey: true
        force: yes
      register: result
      retries: "{{ number_of_retries }}"
      until: result is succeeded
      delay: "{{ retry_delay }}"

    - name: make sure repository exists
      git:
        repo: "{{ git_repo_url }}"
        dest: "{{ git_repo_dest }}"
        version: "{{ git_repo_branch }}"
        accept_hostkey: true
        update: false
      when: not always_clean_repository

  always:
    - name: remove .smartedge_gitconfig
      include_tasks: ./gitconfig_remove.yml
